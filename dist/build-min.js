"use strict";var panel={render(){let e=document.createElement("div");return e.classList.add("panel-wrap"),e.innerHTML='<div class="b-panel"></div>',document.body.appendChild(e),this.panel_wrap=e,document.addEventListener("keydown",function(e){e.shiftKey&&"Space"==e.code&&(e.preventDefault(),panel.switched())}),this},switched(){let e=this.panel_wrap;e.classList.contains("panel-wrap--active")?(wathc.stop(),e.classList.remove("panel-wrap--active")):(wathc.start(),e.classList.add("panel-wrap--active"))},add(e){return this.panel_wrap.querySelector(".b-panel").appendChild(e),this}},villages_maneger={render(){let e=this.dataLoad(),t=document.createElement("div");return t.classList.add("villages"),t.innerHTML=`<h2>Деревни</h2><hr><div class="villages-list">${this.villages_list_render(e)}</div>`,t},reload(){let e=document.querySelector(".b-panel .villages"),t=villages_maneger.render();e.innerHTML=t.innerHTML},villages_list_render:e=>e.map(e=>`<div class="village ${e.id==url_map.idCurrentVillage?"village--active":""}" ><a href="${e.href}">${e.label}</a><div>Дерево: ${e.wood}; Глина:${e.stone}; Сталь:${e.iron}</div><div class="village__builds"> ${builds.getBuildsInfo(e.id)} </div></div>`).join(""),dataLoad(){let e=getPageInBox(url_map.villages),t=[];return(e=e.querySelectorAll("#production_table .nowrap")).forEach(function(e){let n=e.querySelector(".quickedit-content a:not(.rename-icon)"),a=e.querySelector(".wood").innerHTML,r=e.querySelector(".stone").innerHTML,l=e.querySelector(".iron").innerHTML,i=e.querySelector(".quickedit-vn").getAttribute("data-id");t.push({href:n.href,label:n.innerHTML,wood:a,stone:r,iron:l,id:i})}),t}},builds={getBuildsInfo(e){let t=this.getBuildsHtml(e),n=this.buildsInfoExtract(t);return n?this.render(n):""},getBuildsHtml:e=>getPageInBox(url_map.villageBuilds(e)).querySelectorAll('[class*=" buildorder"]'),buildsInfoExtract:e=>(e.map=[].map,e.map(function(e){return{name:e.querySelectorAll(".lit-item")[0].innerText,time:e.querySelectorAll(".lit-item")[1].innerText}})),render:e=>e.map(e=>`<span>${e.name}; Завершение: ${e.time};</span>`).join("")},bookmarks={render(){let e=document.createElement("div"),t=`<a href="${url_map.areaPage}">Площадь</a><a href="${url_map.villageBuilds()}">Ратуша</a><a href="${url_map.recruitmentPage}">Набор рекрутов</a><a href="${url_map.gatheringPage}">Сбор ресурсов</a>`;return e.classList.add("bookmarks"),e.innerHTML=t,e}};const url_map={get location(){return window.location},get villages(){let e=this.location;return`${e.origin}${e.pathname}?screen=overview_villages`},get idCurrentVillage(){let e=this.location.search;return new URLSearchParams(e).get("village")},villageBuilds(e){let t=this.location;return`${t.origin}${t.pathname}?village=${e||this.idCurrentVillage}&screen=main`},get areaPage(){let e=this.location;return`${e.origin}${e.pathname}?village=${this.idCurrentVillage}&screen=place`},get recruitmentPage(){let e=this.location;return`${e.origin}${e.pathname}?village=${this.idCurrentVillage}&screen=train`},get gatheringPage(){let e=this.location;return`${e.origin}${e.pathname}?village=${this.idCurrentVillage}&screen=place&mode=scavenge`}},templ={generateTemplBox(){let e=document.createElement("div");return storage.get("templ").forEach(function(t){let n=document.createElement("button");n.setAttribute("data-units",JSON.stringify(t.units)),n.addEventListener("click",templ.use),n.innerHTML=t.name,e.appendChild(n)}),e},generateTemplContext(){let e=document.createElement("div");return e.innerHTML='<button class="add-templ">Добавить шаблон</button><input type="text" name="templ-name" placeholder="Введите имя нового шаблона">',e.appendChild(templ.generateTemplBox()),e.querySelector(".add-templ").addEventListener("click",()=>templ.add()),e},use(){let e=JSON.parse(this.getAttribute("data-units"));Object.keys(e).forEach(function(t){document.querySelector(`input[name="${t}"]`).value=e[t]}),removeContext()},add(e){let t=storage.get("templ"),n={name:document.querySelector('input[name="templ-name"]').value||"Без имени",units:{}};document.querySelectorAll('input[id*="unit_input"]').forEach(function(e){let t=e.name,a=e.value;a&&(n.units[t]=a)}),t.push(n),storage.set("templ",t),removeContext()}},storage={get:e=>localStorage.getItem(e)?JSON.parse(localStorage.getItem(e)):(storage.set(e,[]),[]),set(e,t){localStorage.setItem(e,JSON.stringify(t))}},keyboard={event(e){if("INPUT"==document.activeElement.tagName)return;let t=e.key;"d"==t?keyboard.villageNext():"a"==t&&keyboard.villagePrevious()},villageNext(){let e=document.querySelector(".village--active").nextElementSibling.querySelector("a").href;location.href=e},villagePrevious(){let e=document.querySelector(".village--active").previousElementSibling.querySelector("a").href;location.href=e}};function requestSync(e){let t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(),200!=t.status?`${t.status}: ${t.statusText}`:t.responseText}function getPageInBox(e,t){let n=document.createElement("div");return n.innerHTML=requestSync(e),t?n.querySelector(t):n}const wathc={start(){this.wathcer=setInterval(villages_maneger.reload,2e3)},stop(){clearInterval(this.wathcer)}};function newContext(e,t,n){let a=document.createElement("div");a.classList.add("b-context"),a.style.cssText=`top: ${n}px; left: ${t}px`,a.appendChild(e),document.body.appendChild(a)}function resetContext(e){let t=document.createElement(".b-context");t.innerHTML="",t.appendChild(e)}function removeContext(){document.querySelector(".b-context").remove()}panel.render().add(bookmarks.render()).add(villages_maneger.render()),document.addEventListener("keydown",keyboard.event),document.querySelector("#command-data-form")&&document.querySelector("#command-data-form").addEventListener("contextmenu",function(e){e.preventDefault(),newContext(templ.generateTemplContext(),e.pageX,e.pageY)}),function(){let e=document.createElement("style");e.innerHTML=":root {--main-bg: #fff;--main-color: #999;--dbl-bg: #eee;--dbl-color: #977;}.panel-wrap {position: fixed;top: 0;left: 0;background: var( --main-bg );box-shadow: 0 0 .5rem var( --main-color );height: 100%;transition: 500ms;  width: .2rem;  opacity: 0; overflow-x: hidden;overflow-y: auto;  z-index: 12324242;}.panel-wrap:hover,.panel-wrap--active {width: 30rem;opacity: 1;}.b-panel,.b-panel *,.b-context * {border: 0;padding: 0;margin:0;outline: none;font-size: 16px;box-sizing: border-box;color: var( --main-color );font-family: Verdana;}.b-panel h2,.b-panel h3,.b-panel p {  padding: .5rem 1rem;}.b-panel hr {border: .1rem solid var( --main-color );margin: .5rem 0;}.b-panel input,.b-panel textarea,.b-panel button {display: block;width: 100%;background: var( --main-bg );padding: 1rem;margin: .5rem 0;transition: 500ms;}.b-panel input:hover,.b-panel textarea:hover,.b-panel button:hover {background: var( --dbl-bg );}.b-panel a {font-style: italic;transition: 500ms;text-decoration: none;}.b-panel a:hover {color: var( --main-color )}.villages-list {margin: .5rem 0;}.villages-list .village {padding: .5rem;}.villages-list .village--active {border-left: .2rem solid #999;}.villages-list .village:nth-child(even) {background: var( --dbl-bg );}.village__builds span {display: block;padding: .2rem 0;}.bookmarks {padding: .5rem 0;}.bookmarks a {display: inline-block;padding: .5rem;}.bookmarks a:hover {background: var( --dbl-bg );}.b-context {position: absolute;background: rgba( 250, 250, 250, .7 );color: #333;}.b-context button,.b-context input {background: rgba( 250, 250, 250, .7 );color: #999;text-align: left;padding: .3rem 1rem;border: 0;width: 100%;transition: 500ms;}.b-context button:hover,.b-context input:hover {background: #fff;}",document.head.appendChild(e)}();